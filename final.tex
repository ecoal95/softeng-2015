\documentclass[12pt,twoside,a4paper]{article}
\usepackage{anyfontsize}
\usepackage{titlesec}
\usepackage[normalem]{ulem}
\usepackage{tocloft}
\usepackage{keycommand}
\usepackage{tabularx}
\usepackage{booktabs}
\usepackage{mathspec}
\usepackage{xltxtra,xunicode}
\usepackage{enumitem}
\usepackage{graphicx}
\usepackage{rotating}
\usepackage{wrapfig}
\usepackage{fancyhdr}
\usepackage{titling}
\usepackage{environ}

\usepackage[margin=1in]{geometry}
\usepackage[spanish]{babel}


\usepackage{etoolbox}

\newcommand\makeenumerate[1]{#1} % TODO

% Without this we have a lot of whitespace issues :/
\raggedbottom

\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\newcommand\cellwidth{\TX@col@width}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\usepackage[setpagesize=false, % page size defined by xetex
          unicode=false, % unicode breaks when used with xetex
          xetex]{hyperref}
\hypersetup{breaklinks=true,
            bookmarks=true,
            pdfauthor={Ejemplo},
            pdftitle={Ejemplo},
            colorlinks=true,
            citecolor=blue,
            urlcolor=blue,
            linkcolor=magenta,
            pdfborder={0 0 0}}
\urlstyle{same}  % don't use monospace font for urls


% Make links footnotes instead of hotlinks:
\renewcommand{\href}[2]{#2\footnote{\url{#1}}}
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
\setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}

\setlength{\headheight}{20.0pt}

\newcommand\reporttitle{Servicio de emergencias}
\newcommand\reportsubtitle{Práctica obligatoria Ingeniería del Software II}
\newcommand\reportdate{4 de diciembre de 2015}
\newcommand\reportauthors{E. Cobos, C. Herrera, V. Barrueco, R. Arroyo, C. Bonal, I. Dragomirov}
\newcommand\version{0.9 (\reportdate)}
\author{
    Emilio Cobos Álvarez (70912324-N) \\
    Celia Herrera Ferreira (70898376-W) \\
    Víctor Barrueco Gutiérrez (53518348-Q) \\
    Rubén Arroyo Rodríguez (70902192-T) \\
    Christian Bonal Martín (70893697-S) \\
    Iskren Dragomirov Mitov (X8422778-V)
}
\title{\reporttitle}

\setmainfont{Times New Roman}
\setsansfont{Liberation Sans}

\fancypagestyle{headings}{%
\fancyhead{}
\fancyfoot{}
\fancyhead[LO]{\bfseries\fontsize{11pt}{2em}\selectfont{\reporttitle}}
\fancyhead[RO,LE]{\bfseries\fontsize{11pt}{2em}\selectfont{\thepage}}
\fancyhead[RE]{\bfseries\fontsize{11pt}{2em}\selectfont{\reportauthors}}
\renewcommand{\headrulewidth}{1pt}
}

% TOC page number
\fancypagestyle{plain}{%
    \fancyhf{}% clears all header and footer fields
    \fancyfoot[C]{\bfseries\fontsize{11pt}{1em}\selectfont --~\thepage~--}%
    \renewcommand*{\headrulewidth}{0pt}%
    \renewcommand*{\footrulewidth}{0pt}%
}

% Título del trabajo. Arial 24 puntos, negrita, centrado. Separación de 120 y 12 puntos con respecto a los párrafos anterior y siguiente respectivamente.
\pretitle{\begin{center}\vspace{120pt}\bfseries\sffamily\fontsize{24pt}{1em}\selectfont}
\posttitle{\vspace{12pt}\end{center}}
% Subtítulo del trabajo. Arial 20 puntos, negrita, centrado. Separación de 12 y 40 puntos con respecto a los párrafos anterior y siguiente respectivamente.
\newcommand{\titlesubtitle}{\begin{center}\sffamily\bfseries\fontsize{20pt}{1em}\selectfont \reportsubtitle \vspace{40pt}\end{center}}

% Versión. Arial 16 puntos, negrita, cursiva, centrado. Separación de 20 puntos con respecto a los párrafos anterior y siguiente.
\newcommand{\titleversion}{\begin{center}\sffamily\bfseries\itshape\fontsize{16pt}{1em}\selectfont Versión \version \vspace{20pt}\end{center}}

% Autores. Arial 14pt alineación izda, separación de 0 con el párrafo superior
\preauthor{\begin{flushleft}\sffamily\bfseries\fontsize{16pt}{1em}}
\postauthor{\end{flushleft}}

% we don't use the latex date to put it before the authors
\date{}
\newcommand{\customdate}{\begin{center}\sffamily\bfseries\itshape\fontsize{16pt}{1em}\selectfont \reportdate \vspace{90pt}\end{center}}
\renewcommand{\maketitlehookb}{\titlesubtitle\titleversion\customdate}

% Secciones en páginas impares
\let\oldsection\section
\def\section{\cleardoublepage\oldsection}

% Esto no está especificado, pero el documento tiene mejor estructura así
% \let\oldsubsection\subsection
% \def\subsection{\clearpage\oldsubsection}

% Tabla de conteidos
% El estilo que se aplicará a esta etiqueta será Arial, 18 puntos, negrita, alineación izquierda, y separación de 20 y 50 puntos con respecto a los párrafos anterior y siguiente respectivamente.
\addto\captionsspanish{
    \renewcommand{\contentsname}{Tabla de contenidos}
}
\setlength\cftbeforetoctitleskip{20pt}
\setlength\cftaftertoctitleskip{50pt}
\renewcommand{\cfttoctitlefont}{\bfseries\sffamily\fontsize{18pt}{1em}\selectfont}

% Títulos de aparado. Arial 14 puntos, negrita, alineación izquierda. Separación de 12 y 6 puntos con respecto a los párrafos anterior y siguiente respectivamente.
\titlespacing*{\section}
    {0pt}{12pt}{6pt}
\titleformat{\section}[hang]
    {\bfseries\sffamily\fontsize{14pt}{1em}\selectfont}{\thesection}{1em}{}
% Títulos de subapartado. Arial 12 puntos, negrita, cursiva alineación izquierda. Separación de 12 y 6 puntos con respecto a los párrafos anterior y siguiente respectivamente.
\titlespacing*{\subsection}
    {0pt}{12pt}{6pt}
\titleformat{\subsection}[hang]
    {\bfseries\sffamily\itshape\fontsize{12pt}{1em}\selectfont}{\thesubsection}{1em}{}

% Títulos de subsubapartado. Arial 12 puntos, subrayado, alineación izquierda. Separación de 12 y 6 puntos con respecto a los párrafos anterior y siguiente respectivamente.
\titlespacing*{\subsubsection}
    {0pt}{12pt}{6pt}
\titleformat{\subsubsection}[hang]
    {\sffamily\fontsize{12pt}{1em}\selectfont}{\thesubsubsection}{1em}{\uline}

% Estilo normal. Times New Roman 12 puntos, alineación completa. Interlineado sencillo. Separación de 0 y

\newcommand\aftertabularx{\vspace{5pt plus 10pt minus 2pt}}
\NewEnviron{customtable}[1][|l|X|]{
%    \begin{minipage}{\linewidth}
    \begin{tabularx}{\linewidth}{#1}
        \BODY
    \end{tabularx}
%    \end{minipage}
    \aftertabularx
}


\newcommand\veryhigh{Muy Alta}
\newcommand\high{Alta}
\newcommand\medium{Media}
\newcommand\low{Baja}
\newcommand\vital{Vital}
\newcommand\verified{Verificado}
\newcommand\validated{Validado}

% name, authors, description, subobjectives, sources
\newkeycommand\objective[id=x,version=\version,importance=\high,urgency=\medium,state=\validated,stability=\high][5]{
% TODO do this more manteinable
\subsubsection{#1} \hfill \\
\begin{customtable}
    \hline
    \textbf{OBJ-\commandkey{id}} & \textbf{#1} \\ \hline
    \textbf{Version} & \commandkey{version} \\ \hline
    \textbf{Autores} & #2 \\ \hline
    \textbf{Descripción} & #3 \\ \hline
    \ifx&#4&\else
    \textbf{Subobjetivos} & #4 \\ \hline
    \fi
    \textbf{Fuentes} & #5 \\ \hline
    \textbf{Importancia} & \commandkey{importance} \\ \hline
    \textbf{Urgencia} & \commandkey{urgency} \\ \hline
    \textbf{Estado} & \commandkey{state} \\ \hline
    \textbf{Estabilidad} & \commandkey{stability} \\ \hline
\end{customtable}
}

% Nombre, dni, rol, descripción
\newcommand\staff[4]{
\begin{customtable}
    \hline
    \textbf{Nombre} & #1 \\ \hline
    \textbf{DNI} & #2 \\ \hline
    \textbf{Rol} & #3 \\ \hline
    \textbf{Descripción} & #4 \\ \hline
\end{customtable}
}

% Nombre, autores, fuentes, objetivos asociados, requisitos asociados, descripción, datos específicos, intervalo temporal
\newkeycommand\informationrequisite[id=x,version=\version,importance=\high,urgency=\medium,state=\validated,stability=\high][8]{
\subsubsection{#1}
\begin{customtable}
    \hline
    \textbf{IRQ-\commandkey{id}} & \textbf{#1} \\ \hline
    \textbf{Versión} & \commandkey{version} \\ \hline
    \textbf{Autores} & #2 \\ \hline
    \textbf{Fuentes} & #3 \\ \hline
    \textbf{Objetivos asociados} & \makeenumerate{#4} \\ \hline
    \textbf{Requisitos asociados} & \makeenumerate{#5} \\ \hline
    % \textbf{Dependencias} & Ver matriz incluida al final del catálogo \\ \hline
    \textbf{Descripción} & #6 \\ \hline
    \textbf{Datos específicos} & \begin{itemize}[noitemsep,nolistsep]#7\end{itemize} \\ \hline
    \textbf{Intervalo temporal} & #8 \\ \hline
    \textbf{Importancia} & \commandkey{importance} \\ \hline
    \textbf{Urgencia} & \commandkey{urgency} \\ \hline
    \textbf{Estado} & \commandkey{state} \\ \hline
    \textbf{Estabilidad} & \commandkey{stability} \\ \hline
\end{customtable}
}

% Nombre, autores, fuentes, objetivos asociados, requisitos asociados, descripción, precondición(es), secuencia normal, postcondición(es), excepciones
\newkeycommand\functionalrequisite[id=x,version=\version,importance=\high,urgency=\medium,state=\validated,stability=\high][9]{
    \def\frid{\commandkey{id}}
    \def\frname{#1}
    \def\frversion{\commandkey{version}}
    \def\frauthors{#2}
    \def\frsources{#3}
    \def\frassocobjs{#4}
    \def\frassocreqs{#5}
    \def\frdescription{#6}
    \def\frpreconds{#7}
    \def\frnormalsequence{#8}
    \def\frpostconds{#9}
    \def\frexceptions{#10}
    \def\frimportance{\commandkey{importance}}
    \def\frurgency{\commandkey{urgency}}
    \def\frstate{\commandkey{state}}
    \def\frstability{\commandkey{stability}}
    \functionalrequisitecont
}

\newcommand\functionalrequisitecont[1]{
% When enabling we get tex capacity exceeded
% \paragraph{\frname} \hfill \\
\begin{customtable}
    \hline
    \textbf{FRQ-\frid} & \textbf{\frname} \\ \hline
    \textbf{Versión} & \frversion \\ \hline
    \textbf{Autores} & \frauthors \\ \hline
    \textbf{Fuentes} & \frsources \\ \hline
    \textbf{Objetivos asociados} & \makeenumerate{\frassocobjs} \\ \hline
    \textbf{Requisitos asociados} & \makeenumerate{\frassocreqs} \\ \hline
    % \textbf{Dependencias} & Ver matriz incluida al final del catálogo \\ \hline
    \textbf{Descripción} & \frdescription \\ \hline
    \textbf{Precondiciones} & \frpreconds \\ \hline
    \textbf{Secuencia normal} &
        {\begin{tabularx}{\cellwidth}{c|X}
            \textbf{Paso} & \textbf{Acción} \\ \hline
            \frnormalsequence
        \end{tabularx}} \\ \hline
    \textbf{Postcondiciones} & \frpostconds \\ \hline
    \textbf{Excepciones} &
        \ifx&#1&\else
        {\begin{tabularx}{\cellwidth}{c|X}
            \textbf{Paso} & \textbf{Acción} \\ \hline
            #1
        \end{tabularx}}
        \fi \\ \hline
    \textbf{Importancia} & \frimportance \\ \hline
    \textbf{Urgencia} & \frurgency \\ \hline
    \textbf{Estado} & \frstate \\ \hline
    \textbf{Estabilidad} & \frstability \\ \hline
\end{customtable}
}

% Nombre, autores, fuentes, objetivos asociados, requisitos asociados, descripción
\newkeycommand\nonfunctionalrequisite[id=x,version=\version,importance=\high,urgency=\medium,state=\validated,stability=\high][6]{
\subsubsection{#1}
\begin{customtable}
    \hline
    \textbf{NFR-\commandkey{id}} & \textbf{#1} \\ \hline
    \textbf{Versión} & \commandkey{version} \\ \hline
    \textbf{Autores} & #2 \\ \hline
    \textbf{Fuentes} & #3 \\ \hline
    \textbf{Objetivos asociados} & \makeenumerate{#4} \\ \hline
    \textbf{Requisitos asociados} & \makeenumerate{#5} \\ \hline
    % \textbf{Dependencias} & Ver matriz incluida al final del catálogo \\ \hline
    \textbf{Descripción} & #6 \\ \hline
    \textbf{Importancia} & \commandkey{importance} \\ \hline
    \textbf{Urgencia} & \commandkey{urgency} \\ \hline
    \textbf{Estado} & \commandkey{state} \\ \hline
    \textbf{Estabilidad} & \commandkey{stability} \\ \hline
\end{customtable}
}

% Nombre, autores, fuentes, descripción
\newkeycommand\actor[id=x,version=\version][4]{
\begin{customtable}
    \hline
    \textbf{ACT-\commandkey{id}} & \textbf{#1} \\ \hline
    \textbf{Versión} & \commandkey{version} \\ \hline
    \textbf{Autores} & #2 \\ \hline
    \textbf{Fuentes} & #3 \\ \hline
    \textbf{Descripción} & #4 \\ \hline
\end{customtable}
}


% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

\begin{document}
\begin{titlingpage}
\maketitle
\thispagestyle{empty}
\end{titlingpage}
\pagestyle{plain}
\setcounter{page}{1}
\hypersetup{linkcolor=black}
\setcounter{tocdepth}{3}
\tableofcontents
\newpage
\pagestyle{headings}

\input{body.tex}

\end{document}
